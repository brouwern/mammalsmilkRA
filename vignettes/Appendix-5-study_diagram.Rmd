---
title: "Appendix 5: Study Diagram"
author: "Vignette Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

A diagrams is often very useful for showing how an experiment was designed, how treatments were allocated, or how there are dependencies in the data.  Below is an example using a graph of the hierarchical phylogenetic relationships.  Zuur & Ieno (2016) emphasize this ("Step 2: Visualize the experimental design" and "Step 4: Identify the dependency structure in the data"; see Figure 4).

## Dependency structure in the mammals milk data

The dependency structure in the mammals milk data is due to phylogeny.  The original paper presents a phylogenetic tree as a figure.  Similarly,  code below is a first attempt to visualize this based on nominal taxonomic categories (class, order, family, genus, species).  Its not very clean yet.  

## Illustrating dependency in a study 

Papers which discuss or have pictures of study diagrams include

Nested by design: model fitting and interpretation in a mixed model era
H Schielzeth, S Nakagawa - Methods in Ecology and Evolution, 2013


Improving basic and translational science by accounting for litter-to-litter variation in animal models SE Lazic, L Essioux - BMC neuroscience, 2013

Four simple ways to increase power without increasing the sample size
Stanley E Lazic Laboratory Animals
https://journals.sagepub.com/doi/full/10.1177/0023677218767478

Analyzing clustered data: why and how to account for multiple observations nested within a study participant? EL Moen, CJ Fricano-Kugler, BW Luikart, AJ O'Malley - Plos one, 2016

Historic disturbance regimes promote tree diversity only under low browsing regimes in eastern deciduous forest
T Nuttle, AA Royo, MB Adams… - Ecological …, 2013 - Wiley Online Library

Long‐term biological legacies of herbivore density in a landscape‐scale experiment: forest understoreys reflect past deer density treatments for at least 20 years
T Nuttle, TE Ristau, AA Royo - Journal of Ecology, 2014

Resolving discrepant findings on ANGPTL8 in β-cell proliferation: a collaborative approach to resolving the betatrophin controversy
AR Cox, O Barrandon, EP Cai, JS Rios, J Chavez… - PloS one, 2016

Meta-evaluation of meta-analysis: ten appraisal questions for biologists
S Nakagawa, DWA Noble, AM Senior… - BMC …, 2017 
https://bmcbiol.biomedcentral.com/articles/10.1186/s12915-017-0357-7


Nonindependence and sensitivity analyses in ecological and evolutionary meta‐analyses …, M Lagisz, RE O'dea, S Nakagawa - Molecular …, 2017

Accounting for multilevel data structures in fisheries data using mixed models
T Wagner, DB Hayes, MT Bremigan - Fisheries, 2006



## Conceptual issues of clustering

The following papers discuss conceptual issues of grouping, clustering etc, but don't have pictures of it.

A solution to dependency: using multilevel analysis to accommodate nested data
E Aarts, M Verhage, JV Veenvliet, CV Dolan… - … neuroscience, 2014

What exactly is 'N'in cell culture and animal experiments?
SE Lazic, CJ Clarke-Williams, MR Munafò - PLoS biology, 2018

The problem of pseudoreplication in neuroscientific studies: is it affecting your analysis? SE Lazic - BMC neuroscience, 2010

Using biological insight and pragmatism when thinking about pseudoreplication
N Colegrave, GD Ruxton - Trends in ecology & evolution, 2017


## Visualizing the sturture of the mammals milk data

### Preliminaries

#### Load packages

```{r}
library(data.tree)
library(treemap)
library(igraph)
library(here)
library(stringr)

```

#### Load data

#### Load data in R

```{r}
file. <- "Appendix-2-Analysis-Data_mammalsmilkRA.csv"
path. <- here("/inst/extdata",file.)

milk <- read.csv(path., skip = 3)


milk$ord <- gsub("11","",milk$ord)
```


#### Cleaning

```{r}
genus_spp_subspp_mat <- milk$spp %>% 
         str_split_fixed(" ", n = 3)

milk$genus <- genus_spp_subspp_mat[,1]

```

#### Set up taxonomy 

##### Class, subclass
```{r}
## class - all mammals
milk$class <- "Mammalia"

## Subclass

### everyone but Monotrmes are Theriiformes
#### = Yinotheria
milk$subclass <- "Theriiformes"
milk$subclass[which(milk$ord == "Monotremata")] <- "Yinotheria"
```


##### Cohort 
```{r}
milk$cohort <- "Placentalia"


Marsupialia <- c("Diprotodontia"  #marsupials
                      ,"Didelphimorphia" #opossums
                      ,"Dasyuromorphia"#tasmanian devil)
                      ,"Peramelemorphia" #bandicoots
                  )

milk$cohort[which(milk$ord %in% Marsupialia)] <- "Marsupialia"


milk$cohort[which(milk$ord == "Monotremata")] <- "Australosphenida"


```

##### magnorder
```{r}
milk$magnorder <- "Xenarthra-or-Epitheria"

milk$magnorder[which(milk$ord == "Monotremata")] <- "Monotremata-magnorder"

 Australidelphia <- c("Diprotodontia"  #marsupials
                      #,"Didelphimorphia" #opossums
                      ,"Dasyuromorphia"#tasmanian devil)
                      ,"Peramelemorphia" #bandicoots
                  )



milk$magnorder[which(milk$ord %in% Australidelphia)] <- "Australidelphia"

milk$magnorder[which(milk$ord == "Didelphimorphia")] <- "Ameridelphia"
```


### Use tables to look at dependencies

```{r}
with(milk,
     table(class, subclass))
with(milk,
     table(subclass, cohort))
with(milk,
     table(cohort, magnorder))
with(milk,
     table(ord, magnorder))
```


### Make hierachical graph

### Set up path string

```{r}
#milk$i <- 1:nrow(milk)
milk$pathString <- with(milk,
                        paste(class,  #Mammalia
                              subclass,
                              cohort,
                              magnorder,
                              ord,
                              #fam,
                              #genus,
                              #spp,
                              #i,
                              sep = "/"))
```


#### Set up nodes

```{r}
milk_tree <- as.Node(milk)
```

#### Print hiearchy as text
```{r}
print(milk_tree, limit = 20)
```

#### Plot

Plot branch diagram
```{r}
plot(milk_tree)
```


Plot dendrogram
```{r}
plot(as.dendrogram(milk_tree),
     horiz = T,
     center = T, 
     cex = 0.5,
     nodePar = 1)
```
